<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Music Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 120px; /* Space for the fixed player */
        }
        /* Custom scrollbar for better aesthetics in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-500 */
        }
        .result-card {
            background-color: #2d3748; /* bg-gray-700 */
            border: 1px solid #4a5568; /* border-gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            margin-bottom: 1rem; /* mb-4 */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            gap: 1rem;
        }
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .result-card img.thumbnail, #playerBar img.thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.375rem; /* rounded-md */
            flex-shrink: 0;
        }
        #playerBar img.thumbnail {
            width: 60px;
            height: 60px;
        }
        .result-card .content {
            flex-grow: 1;
        }
        .play-button {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            transition: background-color 0.15s ease-in-out;
            cursor: pointer;
            border: none;
            margin-top: 0.5rem;
        }
        .play-button:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
        }
        #playerBar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1f2937; /* bg-gray-800 */
            border-top: 1px solid #374151; /* border-gray-700 */
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        #playerBar .track-info {
            flex-grow: 1;
            min-width: 0; /* Prevent overflow issues with long text */
        }
        #playerBar .track-info p {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #playerBar .controls button {
            background: none;
            border: none;
            color: #9ca3af; /* text-gray-400 */
            padding: 0.5rem;
            cursor: pointer;
            transition: color 0.15s ease-in-out;
        }
        #playerBar .controls button:hover {
            color: #e5e7eb; /* text-gray-200 */
        }
        #playerBar .controls button.active {
            color: #8b5cf6; /* text-purple-500 */
        }
        #playerBar .controls svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col items-center pt-8 pb-16 px-4">

    <div class="w-full max-w-3xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-purple-400">YouTube Music Prototype</h1>
            <p class="text-gray-400 mt-2">Find and play music using the YouTube Media Connect API.</p>
        </header>

        <div id="authContainer" class="mb-6 bg-gray-800 p-6 rounded-lg shadow-xl">
             <div id="loginFormContainer">
                <div class="flex flex-col space-y-4">
                     <input type="password" id="accessTokenInput" placeholder="Paste your Access Token here"
                           class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md p-3 focus:ring-purple-500 focus:border-purple-500 placeholder-gray-500">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="getTokenButton" class="w-full sm:w-auto flex-grow bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                            Get Access Token
                        </button>
                        <button id="submitTokenButton" class="w-full sm:w-auto flex-grow bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                            Submit Token
                        </button>
                    </div>
                </div>
            </div>
             <div id="logoutContainer" class="mt-4 text-center hidden">
                <p id="authStatus" class="text-sm text-green-400 mb-2"></p>
                <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                    Logout
                </button>
            </div>
        </div>
        
        <div id="mainAppContent" class="hidden">
            <div id="searchControls" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="searchQuery" class="block text-sm font-medium text-gray-300 mb-1">Search Query</label>
                        <input type="text" id="searchQuery" name="searchQuery" placeholder="e.g., Hello Adele"
                               class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md p-3 focus:ring-purple-500 focus:border-purple-500 placeholder-gray-500">
                    </div>
                    <div>
                        <label for="contentType" class="block text-sm font-medium text-gray-300 mb-1">Content Type</label>
                        <select id="contentType" name="contentType"
                                class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md p-3 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">All</option>
                            <option value="artist">Artist</option>
                            <option value="playlist">Playlist</option>
                            <option value="podcast">Podcast</option>
                            <option value="track">Track</option>
                            <option value="release">Release</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="explicitFilter" name="explicitFilter" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <span class="text-gray-300">Filter explicit content</span>
                    </label>
                </div>
                <button id="searchButton"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                    Search
                </button>
            </div>

            <div id="messageArea" class="mb-6 text-center"></div>

            <div id="resultsContainer" class="space-y-6">
                <section id="topResultsSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-3 text-purple-300 border-b-2 border-gray-700 pb-2">Top Results</h2>
                    <div id="topResultsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>
                <section id="artistsSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-3 text-pink-300 border-b-2 border-gray-700 pb-2">Artists</h2>
                    <div id="artistsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>
                <section id="releasesSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-3 text-green-300 border-b-2 border-gray-700 pb-2">Releases</h2>
                    <div id="releasesList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>
                <section id="playlistsSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-3 text-indigo-300 border-b-2 border-gray-700 pb-2">Playlists</h2>
                    <div id="playlistsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>
                <section id="podcastShowsSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-3 text-yellow-300 border-b-2 border-gray-700 pb-2">Podcast Shows</h2>
                    <div id="podcastShowsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>
                <section id="podcastEpisodesSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-3 text-orange-300 border-b-2 border-gray-700 pb-2">Podcast Episodes</h2>
                    <div id="podcastEpisodesList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>
                 <section id="tracksSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-3 text-teal-300 border-b-2 border-gray-700 pb-2">Tracks</h2>
                    <div id="tracksList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>
            </div>
        </div>
    </div>

    <div id="playerBar" class="hidden">
        <img id="playerTrackImage" src="https://placehold.co/60x60/1F2937/4B5563?text=P" alt="Track Art" class="thumbnail">
        <div class="track-info">
            <p id="playerTrackTitle" class="text-sm font-semibold text-gray-100">No track playing</p>
            <p id="playerTrackArtist" class="text-xs text-gray-400">...</p>
        </div>
        <div class="controls flex items-center gap-2">
            <button id="shuffleButton" title="Shuffle">
                <svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"></path></svg>
            </button>
            <button id="prevButton" title="Previous">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg>
            </button>
            <button id="playPauseButton" title="Play">
                <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                <svg id="pauseIcon" viewBox="0 0 24 24" class="hidden"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
            </button>
            <button id="nextButton" title="Next">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
            </button>
            <button id="repeatButton" title="Repeat">
                 <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"></path></svg>
            </button>
        </div>
    </div>
    <audio id="audioPlayer"></audio>

    <script>
        // --- DOM Elements ---
        const authContainer = document.getElementById('authContainer');
        const accessTokenInput = document.getElementById('accessTokenInput');
        const submitTokenButton = document.getElementById('submitTokenButton');
        const getTokenButton = document.getElementById('getTokenButton');
        const loginFormContainer = document.getElementById('loginFormContainer');
        const logoutContainer = document.getElementById('logoutContainer');
        const authStatus = document.getElementById('authStatus');
        const logoutButton = document.getElementById('logoutButton');
        
        const mainAppContent = document.getElementById('mainAppContent');
        const searchControls = document.getElementById('searchControls');
        const searchQueryInput = document.getElementById('searchQuery');
        const contentTypeSelect = document.getElementById('contentType');
        const explicitFilterCheckbox = document.getElementById('explicitFilter');
        const searchButton = document.getElementById('searchButton');
        const messageArea = document.getElementById('messageArea');
        
        const resultsContainer = document.getElementById('resultsContainer');
        const topResultsSection = document.getElementById('topResultsSection');
        const topResultsList = document.getElementById('topResultsList');

        // --- Player UI Elements ---
        const playerBar = document.getElementById('playerBar');
        const playerTrackImage = document.getElementById('playerTrackImage');
        const playerTrackTitle = document.getElementById('playerTrackTitle');
        const playerTrackArtist = document.getElementById('playerTrackArtist');
        const playPauseButton = document.getElementById('playPauseButton');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const shuffleButton = document.getElementById('shuffleButton');
        const repeatButton = document.getElementById('repeatButton');
        const audioPlayer = document.getElementById('audioPlayer');

        const sections = {
            artists: { element: document.getElementById('artistsSection'), list: document.getElementById('artistsList'), dataKey: 'artist', renderer: renderArtist },
            releases: { element: document.getElementById('releasesSection'), list: document.getElementById('releasesList'), dataKey: 'release', renderer: renderRelease },
            playlists: { element: document.getElementById('playlistsSection'), list: document.getElementById('playlistsList'), dataKey: 'playlist', renderer: renderPlaylist },
            podcastShows: { element: document.getElementById('podcastShowsSection'), list: document.getElementById('podcastShowsList'), dataKey: 'podcastShow', renderer: renderPodcastShow },
            podcastEpisodes: { element: document.getElementById('podcastEpisodesSection'), list: document.getElementById('podcastEpisodesList'), dataKey: 'podcastEpisode', renderer: renderPodcastEpisode },
            tracks: { element: document.getElementById('tracksSection'), list: document.getElementById('tracksList'), dataKey: 'track', renderer: renderTrack },
        };

        // --- API Configuration ---
        const API_BASE_URL = 'https://youtubemediaconnect.googleapis.com/v1';
        
        let accessToken = null;
        let currentQueueId = null;
        let currentTrackDetails = null;
        let currentRepeatMode = 'OFF';
        let currentShuffleMode = 'OFF';

        // --- Utility Functions ---
        function getImageUrl(images) {
            if (images && images.length > 0 && images[0].uri) {
                return images[0].uri;
            }
            return `https://placehold.co/80x80/2D3748/E2E8F0?text=No+Image`;
        }
        
        function renderImage(images, altText = "Cover Art") {
            const imageUrl = getImageUrl(images);
            return `<img src="${imageUrl}" alt="${altText}" class="thumbnail" onerror="this.onerror=null;this.src='https://placehold.co/80x80/2D3748/E2E8F0?text=Error';">`;
        }

        function formatDuration(durationStr) {
            if (!durationStr || !durationStr.endsWith('s')) return 'N/A';
            const totalSeconds = parseInt(durationStr.slice(0, -1), 10);
            if (isNaN(totalSeconds)) return 'N/A';
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // --- Generic API Call Function ---
        async function makeApiCall(endpoint, method = 'GET', body = null, isPlayerAction = false) {
            if (!accessToken) {
                showMessage('Authentication required. Please submit a valid access token.', 'error');
                if (isPlayerAction) playerBar.classList.add('hidden');
                return null;
            }
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'Device-Info': "brand=TestBrandName; model=TestModelName; software_version=1.2.3;",
                'X-Remote-IP': "107.178.207.152",
                'X-Region-Code': "US"
            };
            if (body) {
                headers['Content-Type'] = 'application/json';
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    let errorMsg = `API Error ${response.status}: ${errorData.error?.message || response.statusText}`;
                    if (response.status === 401) {
                        errorMsg += "<br>Your Access Token may be invalid or expired. Please get a new one and submit it again.";
                        handleLogout();
                    }
                    showMessage(errorMsg, 'error');
                    return null;
                }
                if (response.status === 204 || response.headers.get("content-length") === "0") { 
                    return { success: true };
                }
                return await response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                showMessage(`Network or API error: ${error.message}`, 'error');
                if (isPlayerAction) playerBar.classList.add('hidden');
                return null;
            }
        }

        // --- Render Functions ---
        function createPlayButton(playableId, itemType) {
            if (typeof playableId !== 'string' || !playableId) {
                return '';
            }
            return `<button class="play-button" data-playable-id="${playableId}" data-item-type="${itemType}">Play</button>`;
        }

        function renderTrack(track) {
            if (!track || typeof track !== 'object') return '';
            const artists = track.artistReferences?.map(a => a.title).join(', ') || 'Unknown Artist';
            const releaseTitle = track.releaseReference?.title || 'Unknown Album';
            const explicitText = track.explicitType && track.explicitType !== 'EXPLICIT_TYPE_UNSPECIFIED' && track.explicitType !== 'NOT_EXPLICIT' ? `<span class="text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-sm ml-2">EXPLICIT</span>` : '';
            
            return `
                <div class="result-card">
                    ${renderImage(track.images, track.title)}
                    <div class="content">
                        <h3 class="text-lg font-semibold text-purple-300">${track.title || 'Untitled Track'} ${explicitText}</h3>
                        <p class="text-sm text-gray-400">Artist(s): ${artists}</p>
                        <p class="text-sm text-gray-400">Album: ${releaseTitle}</p>
                        <p class="text-sm text-gray-400">Duration: ${formatDuration(track.duration)}</p>
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${track.name}">ID: ${track.name || 'N/A'}</p>
                        ${createPlayButton(track.name, 'track')}
                    </div>
                </div>`;
        }
        
        function renderArtist(artist) {
            if (!artist || typeof artist !== 'object') return '';
            return `
                <div class="result-card">
                    ${renderImage(artist.images, artist.title)}
                    <div class="content">
                        <h3 class="text-lg font-semibold text-pink-300">${artist.title || 'Unknown Artist'}</h3>
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${artist.name}">ID: ${artist.name || 'N/A'}</p>
                        ${createPlayButton(artist.name, 'artist')}
                    </div>
                </div>`;
        }

        function renderRelease(release) {
            if (!release || typeof release !== 'object') return '';
            const artists = release.artistReferences?.map(a => a.title).join(', ') || 'Unknown Artist';
            const explicitText = release.explicitType && release.explicitType !== 'EXPLICIT_TYPE_UNSPECIFIED' && release.explicitType !== 'NOT_EXPLICIT' ? `<span class="text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-sm ml-2">EXPLICIT</span>` : '';
            return `
                <div class="result-card">
                    ${renderImage(release.images, release.title)}
                    <div class="content">
                        <h3 class="text-lg font-semibold text-green-300">${release.title || 'Untitled Release'} ${explicitText}</h3>
                        <p class="text-sm text-gray-400">Artist(s): ${artists}</p>
                        <p class="text-sm text-gray-400">Items: ${release.itemCount || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${release.name}">ID: ${release.name || 'N/A'}</p>
                        ${createPlayButton(release.name, 'release')}
                    </div>
                </div>`;
        }
        
        function renderPlaylist(playlist) {
            if (!playlist || typeof playlist !== 'object') return '';
            return `
                <div class="result-card">
                    ${renderImage(playlist.images, playlist.title)}
                    <div class="content">
                        <h3 class="text-lg font-semibold text-indigo-300">${playlist.title || 'Untitled Playlist'}</h3>
                        <p class="text-sm text-gray-400">Owner: ${playlist.owner?.title || 'Unknown'}</p>
                        <p class="text-sm text-gray-400">Items: ${playlist.itemCount || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${playlist.name}">ID: ${playlist.name || 'N/A'}</p>
                        ${createPlayButton(playlist.name, 'playlist')}
                    </div>
                </div>`;
        }

        function renderPodcastShow(podcastShow) {
            if (!podcastShow || typeof podcastShow !== 'object') return '';
            return `
                <div class="result-card">
                    ${renderImage(podcastShow.images, podcastShow.title)}
                    <div class="content">
                        <h3 class="text-lg font-semibold text-yellow-300">${podcastShow.title || 'Untitled Show'}</h3>
                        <p class="text-sm text-gray-400">Author(s): ${podcastShow.authors?.map(a => a.title).join(', ') || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${podcastShow.name}">ID: ${podcastShow.name || 'N/A'}</p>
                        ${createPlayButton(podcastShow.name, 'podcastShow')}
                    </div>
                </div>`;
        }

        function renderPodcastEpisode(podcastEpisode) {
            if (!podcastEpisode || typeof podcastEpisode !== 'object') return '';
            return `
                <div class="result-card">
                    ${renderImage(podcastEpisode.images, podcastEpisode.title)}
                    <div class="content">
                        <h3 class="text-lg font-semibold text-orange-400">${podcastEpisode.title || 'Untitled Episode'}</h3>
                        <p class="text-sm text-gray-400">Show: ${podcastEpisode.podcastShowReference?.title || 'N/A'}</p>
                        <p class="text-sm text-gray-400">Duration: ${formatDuration(podcastEpisode.duration)}</p>
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${podcastEpisode.name}">ID: ${podcastEpisode.name || 'N/A'}</p>
                        ${createPlayButton(podcastEpisode.name, 'podcastEpisode')}
                    </div>
                </div>`;
        }

        function renderResultItem(resultItem) {
            if (!resultItem || typeof resultItem !== 'object' || Object.keys(resultItem).length === 0) return '';
            if (resultItem.track) return renderTrack(resultItem.track);
            if (resultItem.artist) return renderArtist(resultItem.artist);
            if (resultItem.release) return renderRelease(resultItem.release);
            if (resultItem.playlist) return renderPlaylist(resultItem.playlist);
            if (resultItem.podcastShow) return renderPodcastShow(resultItem.podcastShow);
            if (resultItem.podcastEpisode) return renderPodcastEpisode(resultItem.podcastEpisode);
            return '';
        }
        
        // --- Player Logic ---
        function updatePlayerUI(trackData) {
            if (!trackData) {
                playerBar.classList.add('hidden');
                return;
            }
            playerTrackImage.src = getImageUrl(trackData.images);
            playerTrackTitle.textContent = trackData.title || 'Unknown Title';
            const artists = trackData.artists?.map(a => a.title).join(', ') || trackData.artistReferences?.map(a => a.title).join(', ') || 'Unknown Artist';
            playerTrackArtist.textContent = artists;
            playerBar.classList.remove('hidden');
        }

        function updatePlayPauseButton(isPlaying) {
            playIcon.classList.toggle('hidden', isPlaying);
            pauseIcon.classList.toggle('hidden', !isPlaying);
            playPauseButton.title = isPlaying ? "Pause" : "Play";
        }
        
        async function initiatePlayback(playableId) {
            showMessage('Preparing playback...', 'loading');
            const explicitParam = explicitFilterCheckbox.checked ? '&explicitFilter=besteffort' : '';
            const queueData = await makeApiCall(`/queues/default:preparePlayback?${explicitParam.substring(1)}`, 'POST', { playableId: playableId }, true);

            if (queueData && queueData.name && queueData.context?.manifest?.streams?.length > 0) {
                currentQueueId = queueData.name;
                currentRepeatMode = queueData.controls?.repeat?.mode || 'OFF';
                currentShuffleMode = queueData.controls?.shuffle?.mode || 'OFF';
                updateShuffleRepeatUI();

                const streamUri = queueData.context.manifest.streams[0].uri;
                const itemKey = Object.keys(queueData.context.item)[0];
                currentTrackDetails = queueData.context.item[itemKey] || {};

                updatePlayerUI(currentTrackDetails);
                audioPlayer.src = streamUri;
                audioPlayer.play().then(() => updatePlayPauseButton(true)).catch(e => {
                    showMessage('Error starting playback.', 'error');
                    updatePlayPauseButton(false);
                });
                showMessage('Playing...', 'success');
            } else {
                showMessage('Failed to prepare playback. Stream not available.', 'error');
                playerBar.classList.add('hidden');
            }
        }

        async function refreshQueueAndPlay() {
            if (!currentQueueId) return;
            const queueData = await makeApiCall(`/${currentQueueId}`, 'GET', null, true);
            if (queueData && queueData.context?.manifest?.streams?.length > 0) {
                const streamUri = queueData.context.manifest.streams[0].uri;
                const itemKey = Object.keys(queueData.context.item)[0];
                currentTrackDetails = queueData.context.item[itemKey] || {};

                updatePlayerUI(currentTrackDetails);
                audioPlayer.src = streamUri;
                audioPlayer.play().then(() => updatePlayPauseButton(true));
                showMessage(`Now Playing: ${currentTrackDetails.title}`, 'info');
            } else {
                showMessage('Failed to get next/previous track info.', 'error');
            }
        }
        
        function updateShuffleRepeatUI() {
            shuffleButton.classList.toggle('active', currentShuffleMode === 'ON');
            repeatButton.classList.toggle('active', currentRepeatMode !== 'OFF');
            shuffleButton.title = `Shuffle: ${currentShuffleMode}`;
            repeatButton.title = `Repeat: ${currentRepeatMode}`;
        }

        // --- Auth Logic ---
        function updateUIWithAuthState() {
            if (accessToken) {
                authStatus.textContent = 'Access Token is active.';
                logoutContainer.classList.remove('hidden');
                loginFormContainer.classList.add('hidden');
                mainAppContent.classList.remove('hidden');
            } else {
                logoutContainer.classList.add('hidden');
                loginFormContainer.classList.remove('hidden');
                mainAppContent.classList.add('hidden');
                playerBar.classList.add('hidden');
                if(audioPlayer) audioPlayer.pause();
                currentQueueId = null;
                Object.values(sections).forEach(sec => {
                    sec.list.innerHTML = '';
                    sec.element.classList.add('hidden');
                });
                topResultsList.innerHTML = '';
                topResultsSection.classList.add('hidden');
            }
        }
        
        function handleSubmitToken() {
            const token = accessTokenInput.value.trim();
            if (!token) {
                showMessage('Please paste an access token first.', 'error');
                return;
            }
            accessToken = token;
            showMessage('Access Token submitted.', 'success');
            updateUIWithAuthState();
        }

        function handleLogout() {
            accessToken = null;
            accessTokenInput.value = '';
            showMessage('You have been logged out.', 'info');
            updateUIWithAuthState();
        }

        // --- Search and Display Logic ---
        function displayResults(data) {
            let hasResults = false;
            Object.values(sections).forEach(sec => {
                sec.list.innerHTML = '';
                sec.element.classList.add('hidden');
            });
            topResultsList.innerHTML = '';
            topResultsSection.classList.add('hidden');
            
            if (data.topResults?.results?.length > 0) {
                topResultsList.innerHTML = data.topResults.results.map(renderResultItem).join('');
                topResultsSection.classList.remove('hidden');
                hasResults = true;
            }

            for (const key in sections) {
                const sectionInfo = sections[key];
                if (data[key]?.results?.length > 0) {
                    sectionInfo.list.innerHTML = data[key].results.map(item => sectionInfo.renderer(item)).join('');
                    sectionInfo.element.classList.remove('hidden');
                    hasResults = true;
                }
            }
            
            if (!hasResults) {
                showMessage('No results found for your query.', 'info');
            } else {
                 if (messageArea.textContent.includes('Searching...')) {
                    messageArea.innerHTML = '';
                 }
            }
        }
        
        function showMessage(text, type = 'info') {
            const colorMap = { 'error': 'text-red-400', 'loading': 'text-blue-300', 'success': 'text-green-400', 'info': 'text-gray-300' };
            messageArea.innerHTML = `<p class="${colorMap[type] || 'text-gray-300'}">${text}</p>`;
        }

        async function handleSearch() {
            const query = searchQueryInput.value.trim();
            if (!query) {
                showMessage('Please enter a search query.', 'error');
                return;
            }

            const type = contentTypeSelect.value;
            const filterExplicit = explicitFilterCheckbox.checked;
            let endpoint = `/music:search?query=${encodeURIComponent(query)}`;
            if (type) endpoint += `&type=${type}`;
            if (filterExplicit) endpoint += `&explicitFilter=besteffort`;
            
            showMessage('Searching...', 'loading');
            const data = await makeApiCall(endpoint);
            if (data) {
                displayResults(data);
            }
        }

        // --- Event Listeners ---
        submitTokenButton.addEventListener('click', handleSubmitToken);
        logoutButton.addEventListener('click', handleLogout);
        getTokenButton.addEventListener('click', () => {
            window.open('https://youtube-media-connect.teams.x20web.corp.google.com/oauth.html', '_blank');
        });
        accessTokenInput.addEventListener('keypress', e => e.key === 'Enter' && handleSubmitToken());

        searchButton.addEventListener('click', handleSearch);
        searchQueryInput.addEventListener('keypress', e => e.key === 'Enter' && handleSearch());
        
        resultsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('play-button')) {
                const playableId = e.target.dataset.playableId;
                if (playableId) initiatePlayback(playableId);
            }
        });

        playPauseButton.addEventListener('click', () => {
            if (audioPlayer.src) {
                audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
            } else if (currentQueueId) {
                refreshQueueAndPlay();
            }
        });
        audioPlayer.addEventListener('play', () => updatePlayPauseButton(true));
        audioPlayer.addEventListener('pause', () => updatePlayPauseButton(false));
        audioPlayer.addEventListener('ended', async () => {
             updatePlayPauseButton(false);
             if (currentRepeatMode === 'CURRENT_ITEM') {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
             } else {
                const result = await makeApiCall(`/${currentQueueId}:next`, 'POST', null, true);
                if (result?.success) refreshQueueAndPlay();
             }
        });

        nextButton.addEventListener('click', async () => {
            if (!currentQueueId) return;
            const result = await makeApiCall(`/${currentQueueId}:next`, 'POST', null, true);
            if (result?.success) refreshQueueAndPlay();
        });

        prevButton.addEventListener('click', async () => {
            if (!currentQueueId) return;
            const result = await makeApiCall(`/${currentQueueId}:previous`, 'POST', null, true);
            if (result?.success) refreshQueueAndPlay();
        });

        shuffleButton.addEventListener('click', async () => {
            if (!currentQueueId) return;
            const newMode = currentShuffleMode === 'ON' ? 'OFF' : 'ON';
            const result = await makeApiCall(`/${currentQueueId}/controls:shuffle`, 'POST', { shuffleMode: newMode }, true);
            if (result) {
                currentShuffleMode = result.shuffle?.mode || newMode;
                updateShuffleRepeatUI();
                showMessage(`Shuffle ${currentShuffleMode}.`, 'info');
            }
        });

        repeatButton.addEventListener('click', async () => {
            if (!currentQueueId) return;
            const newMode = currentRepeatMode === 'OFF' ? 'ALL' : (currentRepeatMode === 'ALL' ? 'CURRENT_ITEM' : 'OFF');
            const result = await makeApiCall(`/${currentQueueId}/controls:repeat`, 'POST', { repeatMode: newMode }, true);
             if (result) {
                currentRepeatMode = result.repeat?.mode || newMode;
                updateShuffleRepeatUI();
                showMessage(`Repeat ${currentRepeatMode}.`, 'info');
            }
        });

        // --- Initial Load ---
        window.addEventListener('load', () => {
            updateUIWithAuthState();
            updateShuffleRepeatUI();
        });
    </script>
</body>
</html>